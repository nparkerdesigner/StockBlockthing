<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Pantry - Camera Fix</title>
<style>
body{font-family:system-ui,-apple-system,sans-serif;margin:0;padding:16px;background:#f2f4f7;color:#111;}
.wrap{max-width:960px;margin:auto;}
header{display:flex;align-items:center;gap:12px;}
header h1{margin:0;font-size:20px;}
.card{background:#fafafa;border-radius:10px;padding:12px;box-shadow:0 1px 4px rgba(0,0,0,0.06);margin-bottom:12px;}
video{width:100%;border-radius:8px;background:#000;}
button{background:#333;color:#fff;border:none;padding:8px 10px;border-radius:6px;cursor:pointer;}
.small{font-size:13px;color:#666;}
.history-item,.inv-item{display:flex;gap:10px;align-items:center;padding:8px;border-radius:8px;margin-bottom:8px;background:white;}
.history-item img,.inv-item img{width:56px;height:56px;object-fit:cover;border-radius:6px;}
.color-good{background:#d4f7d4;}
.color-warn{background:#fff3cd;}
.color-bad{background:#ffd6d6;}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.4);justify-content:center;align-items:center;}
.modal-content{background:#fff;padding:16px;border-radius:10px;width:90%;max-width:400px;position:relative;}
.modal-content label{display:block;margin-top:8px;}
.modal-close{position:absolute;top:8px;right:8px;cursor:pointer;font-weight:bold;}
#camera-error{color:red;text-align:center;padding:12px;}
</style>
</head>
<body>
<div class="wrap">
<header><h1>ðŸ“¦ Smart Pantry</h1><div class="small">Scan, track expiry, recipes & deals</div></header>

<div class="card">
<video id="video" playsinline autoplay></video>
<div id="camera-error" class="small"></div>
</div>

<div class="card" id="product-info"><div class="small center">Scan a barcode to begin</div></div>

<div class="card">
<h3>Scan History</h3>
<div id="history-list"></div>
</div>

<div class="card">
<h3>Inventory</h3>
<div id="inventory-list"></div>
</div>
</div>

<script src="https://unpkg.com/quagga/dist/quagga.min.js"></script>
<script>
const video = document.getElementById('video');
const cameraError = document.getElementById('camera-error');

// Camera initialization
function startCamera(){
  if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
    cameraError.textContent = "Camera not supported on this browser.";
    return;
  }
  navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}})
    .then(stream=>{video.srcObject=stream; initQuagga();})
    .catch(err=>{console.error(err); cameraError.textContent="Camera access denied.";});
}

// Inventory / Scan storage
let scanHistory = JSON.parse(localStorage.getItem('scanHistory')||'[]');
let inventory = JSON.parse(localStorage.getItem('inventory')||'[]');

function saveData(){localStorage.setItem('scanHistory',JSON.stringify(scanHistory));localStorage.setItem('inventory',JSON.stringify(inventory));}

// Render
function renderHistory(){
  const container = document.getElementById('history-list');
  container.innerHTML = scanHistory.length?scanHistory.map((h,i)=>`<div class="history-item">
    <div style="flex:1"><strong>${h.title}</strong><div class="small">UPC:${h.barcode}</div></div>
    <div><button onclick="addToInventory(${i})">Add</button></div>
  </div>`).join(''):'<div class="small">No scans yet</div>';
}
function renderInventory(){
  const container = document.getElementById('inventory-list');
  container.innerHTML = inventory.length?inventory.map((item,i)=>{
    const cls = (item.quantity<=2?'color-warn':'color-good');
    return `<div class="inv-item ${cls}">
      <div style="flex:1"><strong>${item.title}</strong><div class="small">Qty:${item.quantity}</div></div>
    </div>`;
  }).join(''):'<div class="small">Inventory empty</div>';
}

// Add to inventory
function addToInventory(idx){
  const hist = scanHistory[idx];
  const found = inventory.find(i=>i.barcode===hist.barcode);
  if(found){found.quantity=(found.quantity||0)+1;} else {inventory.unshift({...hist,quantity:1});}
  saveData(); renderInventory();
}

// Quagga scanner
function initQuagga(){
  Quagga.init({inputStream:{name:"Live",type:"LiveStream",target:video,constraints:{facingMode:"environment"}},decoder:{readers:["ean_reader","upc_reader"]}},function(err){if(err){console.error(err); cameraError.textContent="Failed to initialize scanner";return;}Quagga.start();});

  let lastDetected=null;
  Quagga.onDetected(result=>{
    const code=result?.codeResult?.code; if(!code) return;
    if(code===lastDetected) return; lastDetected=code; setTimeout(()=>lastDetected=null,1500);
    const exists = scanHistory.find(h=>h.barcode===code);
    if(!exists){scanHistory.unshift({barcode:code,title:'Product '+code}); saveData(); renderHistory();}
  });
}

// Start camera
startCamera();
renderHistory(); renderInventory();
</script>
</body>
</html>
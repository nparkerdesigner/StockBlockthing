<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Pantry Prototype</title>
<style>
body{font-family:system-ui,-apple-system,sans-serif;margin:0;padding:16px;background:#f2f4f7;color:#111;}
.wrap{max-width:960px;margin:auto;}
header{display:flex;align-items:center;gap:12px;flex-wrap:wrap;}
header h1{margin:0;font-size:22px;}
.card{background:#fafafa;border-radius:10px;padding:12px;box-shadow:0 1px 4px rgba(0,0,0,0.06);margin-bottom:12px;}
video{width:100%;border-radius:8px;background:#000;}
button{background:#333;color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;}
button.buy{background:green;}
.small{font-size:13px;color:#666;}
.inv-item{display:flex;gap:10px;align-items:center;padding:8px;border-radius:8px;margin-bottom:8px;background:white;}
.inv-item img{width:56px;height:56px;object-fit:cover;border-radius:6px;}
.color-good{background:#d4f7d4;}
.color-warn{background:#fff3cd;}
.color-bad{background:#ffd6d6;}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.4);justify-content:center;align-items:center;}
.modal-content{background:#fff;padding:16px;border-radius:10px;width:90%;max-width:400px;position:relative;}
.modal-content label{display:block;margin-top:8px;}
.modal-close{position:absolute;top:8px;right:8px;cursor:pointer;font-weight:bold;}
#camera-error{color:red;text-align:center;padding:12px;}
#current-product{display:flex;gap:10px;align-items:center;margin-top:10px;}
#current-product img{width:60px;height:60px;object-fit:cover;border-radius:6px;}
</style>
</head>
<body>
<div class="wrap">
<header>
  <h1>ðŸ“¦ Smart Pantry Prototype</h1>
  <div class="small" id="current-time"></div>
</header>

<div class="card">
  <video id="video" playsinline autoplay></video>
  <div id="camera-error" class="small">Initializing camera...</div>
  <div id="current-product"></div>
</div>

<div class="card">
<h3>Inventory</h3>
<div id="inventory-list"></div>
</div>
</div>

<div class="modal" id="modal">
<div class="modal-content">
<span class="modal-close" id="modal-close">&times;</span>
<h3>Edit / Add Item</h3>
<label>Title: <input type="text" id="modal-title"></label>
<label>Brand: <input type="text" id="modal-brand"></label>
<label>Description: <input type="text" id="modal-desc"></label>
<label>Quantity: <input type="number" id="modal-qty"></label>
<label>Expiry: <input type="date" id="modal-expiry"></label>
<label>Image URL: <input type="text" id="modal-image"></label>
<div style="margin-top:10px;">
  <button id="modal-add">Add to Inventory</button>
  <button id="modal-buy" class="buy">Buy Now</button>
</div>
</div>
</div>

<script src="https://unpkg.com/quagga/dist/quagga.min.js"></script>
<script>
const video=document.getElementById('video');
const cameraError=document.getElementById('camera-error');
const E={
  inventoryList:document.getElementById('inventory-list'),
  modal:document.getElementById('modal'),
  modalClose:document.getElementById('modal-close'),
  modalAdd:document.getElementById('modal-add'),
  modalBuy:document.getElementById('modal-buy'),
  modalTitle:document.getElementById('modal-title'),
  modalBrand:document.getElementById('modal-brand'),
  modalDesc:document.getElementById('modal-desc'),
  modalQty:document.getElementById('modal-qty'),
  modalExpiry:document.getElementById('modal-expiry'),
  modalImage:document.getElementById('modal-image'),
  currentProductDiv:document.getElementById('current-product')
};

let inventory=JSON.parse(localStorage.getItem('inventory')||'[]');
let currentProduct=null;
let scanLocked=false;

// Example products for demo
const exampleProducts=[
  {title:"Cheerios",brand:"General Mills",desc:"Delicious tasty cereal",image:"https://images.unsplash.com/photo-1590080875632-d5b601b48c0b?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&h=60&w=60"},
  {title:"Coca-Cola",brand:"Coca-Cola",desc:"Refreshing soda drink",image:"https://images.unsplash.com/photo-1587732380910-16b9c7b9c650?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&h=60&w=60"},
  {title:"Eggs",brand:"Organic Farms",desc:"Fresh organic eggs",image:"https://images.unsplash.com/photo-1585238342020-7d4ab06a8c8e?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&h=60&w=60"},
  {title:"Milk",brand:"DairyLand",desc:"Full cream milk",image:"https://images.unsplash.com/photo-1585238341877-1b3d6c8c8b26?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&h=60&w=60"},
  {title:"Bread",brand:"Wonder",desc:"Soft white bread",image:"https://images.unsplash.com/photo-1576418887370-1a23b1c611d1?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&h=60&w=60"},
  {title:"Peanut Butter",brand:"Jif",desc:"Creamy peanut butter",image:"https://images.unsplash.com/photo-1590080875554-8f3d991b63d0?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&h=60&w=60"}
];

// Save inventory
function saveData(){localStorage.setItem('inventory',JSON.stringify(inventory));}

// Show current time
function updateTime(){document.getElementById('current-time').textContent='Current: '+new Date().toLocaleString();}
setInterval(updateTime,1000); updateTime();

// Color coding
function colorForItem(item){
  const days=item.expiry?Math.round((new Date(item.expiry)-new Date())/(24*60*60*1000)):null;
  if((days!==null && days<0) || item.quantity<=0) return 'color-bad';
  if((days!==null && days<=3) || item.quantity<=2) return 'color-warn';
  return 'color-good';
}

// Render inventory
function renderInventory(){
  E.inventoryList.innerHTML=inventory.length?inventory.map((item,i)=>{
    const cls=colorForItem(item);
    return `<div class="inv-item ${cls}">
      ${item.image?`<img src="${item.image}">`:`<div style="width:56px;height:56px;background:#eee;border-radius:6px;display:flex;align-items:center;justify-content:center">?</div>`}
      <div style="flex:1">
        <strong>${item.title}</strong><div class="small">${item.brand||''}</div><div class="small">${item.desc||''}</div>
        <div class="small">Qty:${item.quantity} Exp:${item.expiry||'â€”'}</div>
      </div>
      <div>
        <button onclick="editItem(${i})">Edit</button>
        <button onclick="removeItem(${i})" style="background:red;margin-left:4px;">Remove</button>
      </div>
    </div>`;
  }).join(''):'<div class="small">Inventory empty</div>';
}

// Render current scanned product
function renderCurrentProduct(){
  if(currentProduct){
    E.currentProductDiv.innerHTML=`<img src="${currentProduct.image}"><div>
      <strong>${currentProduct.title}</strong><div class="small">${currentProduct.brand}</div>
      <div class="small">${currentProduct.desc}</div>
      <button onclick="openModalForCurrent()">Add / Edit</button>
    </div>`;
  } else E.currentProductDiv.innerHTML='';
}

// Add / remove / edit
function editItem(idx){
  currentProduct = inventory[idx];
  openModalForCurrent();
}

function removeItem(idx){
  if(confirm(`Remove "${inventory[idx].title}" from inventory?`)){
    inventory.splice(idx,1);
    saveData();
    renderInventory();
  }
}

// Modal
function openModalForCurrent(){
  if(!currentProduct) return;
  E.modalTitle.value=currentProduct.title;
  E.modalBrand.value=currentProduct.brand||'';
  E.modalDesc.value=currentProduct.desc||'';
  E.modalQty.value=currentProduct.quantity||1;
  E.modalExpiry.value=currentProduct.expiry||'';
  E.modalImage.value=currentProduct.image||'';
  E.modal.style.display='flex';
}

E.modalClose.onclick=()=>{E.modal.style.display='none'; currentProduct=null; scanLocked=false;};

E.modalAdd.onclick=()=>{
  if(!currentProduct) return;
  currentProduct.title=E.modalTitle.value;
  currentProduct.brand=E.modalBrand.value;
  currentProduct.desc=E.modalDesc.value;
  currentProduct.quantity=parseInt(E.modalQty.value)||1;
  currentProduct.expiry=E.modalExpiry.value||randomExpiry();
  currentProduct.image=E.modalImage.value||'https://via.placeholder.com/56';
  inventory.unshift(currentProduct);
  saveData();
  renderInventory();
  E.modal.style.display='none';
  currentProduct=null;
  renderCurrentProduct();
  scanLocked=false;
  notifyIfExpiring(inventory[0]);
};

E.modalBuy.onclick=()=>{
  if(currentProduct) window.open(`https://flipp.com/search?q=${encodeURIComponent(currentProduct.title)}`,'_blank');
};

// Random expiry (1-14 days)
function randomExpiry(){
  const d=new Date();
  d.setDate(d.getDate()+Math.floor(Math.random()*14)+1);
  return d.toISOString().split('T')[0];
}

// Notification for expiring items
function notifyIfExpiring(item){
  if(Notification.permission!=='granted') Notification.requestPermission();
  const days=item.expiry?Math.round((new Date(item.expiry)-new Date())/(24*60*60*1000)):null;
  if(days!==null && days<=3 && Notification.permission==='granted'){
    new Notification('Expiring Soon!',{body:`${item.title} expires in ${days} day(s)`});
  }
}

// Quagga scanner
function initQuagga(){
  Quagga.init({
    inputStream:{name:"Live",type:"LiveStream",target:video,constraints:{facingMode:"environment"}},
    decoder:{readers:["ean_reader","upc_reader","upc_e_reader"]}
  }, function(err){
    if(err){console.error(err); cameraError.textContent="Scanner init failed"; return;}
    Quagga.start();
  });

  Quagga.onDetected(r=>{
    if(scanLocked) return;
    const code=r?.codeResult?.code;
    if(!code) return;
    scanLocked=true;

    // Pick random example product for demo
    currentProduct = {...exampleProducts[Math.floor(Math.random()*exampleProducts.length)], barcode: code, expiry: randomExpiry()};
    renderCurrentProduct();
    openModalForCurrent();
  });
}

// Camera
function startCamera(){
  if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
    cameraError.textContent="Camera not supported"; return;
  }
  navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}})
    .then(stream=>{video.srcObject=stream; video.onloadedmetadata=()=>{video.play(); cameraError.textContent=""; initQuagga();};})
    .catch(err=>{console.error(err); cameraError.textContent="Camera access denied";});
}

// INIT
startCamera();
renderInventory();
</script>
</body>
</html>